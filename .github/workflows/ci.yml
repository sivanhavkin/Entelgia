name: ðŸ§ª Entelgia CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ============================================
  # Job 1: Tests & Code Quality
  # ============================================
  test:
    name: ðŸ§ª Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
    
    steps:
    # â”€â”€ Step 1: Checkout code â”€â”€
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    # â”€â”€ Step 2: Set up Python â”€â”€
    - name: ðŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    # â”€â”€ Step 3: Install dependencies â”€â”€
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-mock black flake8 mypy
    
    # â”€â”€ Step 4: Run tests with coverage â”€â”€
    - name: âœ… Run tests
      run: |
        pytest tests/ -v --cov=. --cov-report=xml --cov-report=term --cov-report=html
    
    # â”€â”€ Step 5: Upload coverage to Codecov â”€â”€
    - name: ðŸ“Š Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    # â”€â”€ Step 6: Archive coverage report â”€â”€
    - name: ðŸ“¦ Archive coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-${{ matrix.python-version }}
        path: htmlcov/
        retention-days: 30

  # ============================================
  # Job 2: Code Quality Checks
  # ============================================
  quality:
    name: ðŸŽ¨ Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ðŸ“¦ Install tools
      run: |
        pip install black flake8 mypy
    
    # â”€â”€ Black: Code formatting â”€â”€
    - name: ðŸ–¤ Check code formatting (black)
      run: |
        black --check --diff .
      continue-on-error: false
    
    # â”€â”€ Flake8: Linting â”€â”€
    - name: ðŸ” Lint code (flake8)
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --max-line-length=88 --statistics
      continue-on-error: true
    
    # â”€â”€ MyPy: Type checking â”€â”€
    - name: ðŸ”Ž Type checking (mypy)
      run: |
        mypy *.py --ignore-missing-imports --show-error-codes
      continue-on-error: true

  # ============================================
  # Job 3: Security Scan
  # ============================================
  security:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    # â”€â”€ Safety: Check for known vulnerabilities â”€â”€
    - name: ðŸ›¡ï¸ Check dependencies (safety)
      run: |
        pip install safety
        safety check --json || true
      continue-on-error: true
    
    # â”€â”€ Bandit: Security issues in code â”€â”€
    - name: ðŸ” Security scan (bandit)
      run: |
        pip install bandit
        bandit -r . -f json -o bandit-report.json || true
      continue-on-error: true
    
    # â”€â”€ Upload security reports â”€â”€
    - name: ðŸ“¤ Upload security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
        retention-days: 30

  # ============================================
  # Job 4: Build Check
  # ============================================
  build:
    name: ðŸ—ï¸ Build Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ðŸ“¦ Install build tools
      run: |
        pip install build twine
    
    - name: ðŸ—ï¸ Build package
      run: |
        python -m build
    
    - name: âœ… Check package
      run: |
        twine check dist/*
    
    - name: ðŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist/
        retention-days: 30

  # ============================================
  # Job 5: Documentation Check
  # ============================================
  docs:
    name: ðŸ“š Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ” Check for broken links in docs
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        config-file: '.github/workflows/mlc_config.json'
      continue-on-error: true
    
    - name: âœ… Verify all docs exist
      run: |
        echo "Checking required documentation files..."
        files=(
          "README.md"
          "Changelog.md"
          "Contributing.md"
          "CODE_OF_CONDUCT.md"
          "SECURITY.md"
          "LICENSE"
          "docs/api/README.md"
        )
        
        missing=0
        for file in "${files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ Missing: $file"
            missing=1
          else
            echo "âœ… Found: $file"
          fi
        done
        
        if [ $missing -eq 1 ]; then
          exit 1
        fi

  # ============================================
  # Job 6: Summary Report
  # ============================================
  report:
    name: ðŸ“Š Summary Report
    runs-on: ubuntu-latest
    needs: [test, quality, security, build, docs]
    if: always()
    
    steps:
    - name: ðŸ“‹ Generate summary
      run: |
        echo "# ðŸŽ‰ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“Š Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ§ª Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŽ¨ Code Quality | ${{ needs.quality.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”’ Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ—ï¸ Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“š Documentation | ${{ needs.docs.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** \`${{ github.ref }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Author:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
